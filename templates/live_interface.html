<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detecci√≥n de Emociones en Vivo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            color: #2d3748;
            margin-bottom: 10px;
        }

        header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-active {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .status-inactive {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        .video-section {
            background: #2d3748;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 500px;
        }

        #videoCanvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            background: #1a202c;
        }

        .video-placeholder i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #667eea;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 10;
        }

        .control-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .control-btn i {
            font-size: 1.2rem;
        }

        .start-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .start-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .stop-btn {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .stop-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .stats-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stats-card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .stats-card h3 i {
            color: #667eea;
        }

        .current-emotion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .emotion-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 15px 0;
            text-transform: capitalize;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confidence-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .confidence-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .emotion-distribution {
            margin-top: 20px;
        }

        .emotion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .emotion-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .emotion-name {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .emotion-percentage {
            font-weight: bold;
            color: #667eea;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            border-left: 4px solid #667eea;
        }

        .history-time {
            color: #718096;
            font-size: 0.8rem;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .session-info {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .info-card {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin-top: 5px;
        }

        .api-info {
            margin-top: 20px;
            padding: 15px;
            background: #edf2f7;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            color: #718096;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1><i class="fas fa-video"></i> Detecci√≥n de Emociones en Vivo</h1>
        <p>Detecci√≥n facial en tiempo real usando Inteligencia Artificial</p>
    </header>

    <div class="status-bar">
        <div class="status-item">
            <span class="status-dot status-inactive" id="statusDot"></span>
            <span id="statusText">Sesi√≥n no iniciada</span>
        </div>
        <div class="status-item">
            <span id="sessionInfo">Sin sesi√≥n activa</span>
        </div>
        <div class="status-item">
            <span id="detectionCount">0 detecciones</span>
        </div>
    </div>

    <div class="content">
        <div class="video-section">
            <div class="video-container">
                <canvas id="videoCanvas"></canvas>
                <div class="video-placeholder" id="videoPlaceholder">
                    <i class="fas fa-video"></i>
                    <p>Presiona "Iniciar Detecci√≥n" para comenzar</p>
                </div>
            </div>
            <div class="controls">
                <button class="control-btn start-btn" id="startBtn" onclick="startDetection()">
                    <i class="fas fa-play"></i> Iniciar Detecci√≥n
                </button>
                <button class="control-btn stop-btn" id="stopBtn" onclick="stopDetection()" disabled>
                    <i class="fas fa-stop"></i> Detener Sesi√≥n
                </button>
                <button class="control-btn capture-btn" id="captureBtn" onclick="captureFrame()" disabled>
                    <i class="fas fa-camera"></i> Capturar Frame
                </button>
            </div>
        </div>

        <div class="stats-section">
            <div class="current-emotion">
                <h3><i class="fas fa-smile"></i> Emoci√≥n Detectada</h3>
                <div class="emotion-display" id="currentEmotion">-</div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceBar" style="width: 0%"></div>
                </div>
                <p id="confidenceText">Confianza: 0%</p>
            </div>

            <div class="stats-card">
                <h3><i class="fas fa-chart-pie"></i> Distribuci√≥n de Emociones</h3>
                <div class="emotion-distribution" id="emotionDistribution">
                    <div class="emotion-item">
                        <span class="emotion-name">Esperando datos...</span>
                        <span class="emotion-percentage">0%</span>
                    </div>
                </div>
            </div>

            <div class="stats-card">
                <h3><i class="fas fa-history"></i> Historial Reciente</h3>
                <div class="history-list" id="historyList">
                    <div class="history-item">
                        <span>No hay detecciones recientes</span>
                    </div>
                </div>
            </div>

            <div class="session-info">
                <div class="info-card">
                    <div><i class="fas fa-clock"></i> Duraci√≥n</div>
                    <div class="info-value" id="duration">00:00</div>
                </div>
                <div class="info-card">
                    <div><i class="fas fa-user"></i> Rostros</div>
                    <div class="info-value" id="faceCount">0</div>
                </div>
                <div class="info-card">
                    <div><i class="fas fa-brain"></i> Predominante</div>
                    <div class="info-value" id="predominantEmotion">-</div>
                </div>
            </div>

            <div class="api-info">
                <p><i class="fas fa-info-circle"></i> <strong>ID de Sesi√≥n:</strong> <span id="sessionId">N/A</span></p>
                <p><i class="fas fa-link"></i> <strong>WebSocket:</strong> <span id="wsStatus">Desconectado</span></p>
            </div>
        </div>
    </div>

    <footer>
        <p>API de Detecci√≥n de Emociones | Puerto: 8000 | WebSocket activo</p>
    </footer>
</div>

<div class="loading" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <p id="loadingText">Iniciando...</p>
    </div>
</div>

<script>
    // Variables globales
    let currentSessionId = null;
    let websocket = null;
    let emotionHistory = [];
    let emotionCounts = {};
    let sessionStartTime = null;
    let updateInterval = null;
    let statsInterval = null;

    // Elementos del DOM
    const videoCanvas = document.getElementById('videoCanvas');
    const ctx = videoCanvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const captureBtn = document.getElementById('captureBtn');

    function showLoading(message) {
        document.getElementById('loadingText').textContent = message;
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    async function startDetection() {
        showLoading('Iniciando sesi√≥n de detecci√≥n...');

        try {
            // 1. Iniciar sesi√≥n en la API
            const response = await fetch('/api/live/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.status === 'success') {
                currentSessionId = data.session_id;
                sessionStartTime = new Date();

                // 2. Actualizar UI
                updateSessionInfo(data);

                // 3. Conectar WebSocket
                connectWebSocket(data.session_id);

                // 4. Iniciar actualizaci√≥n de estad√≠sticas
                startStatsUpdate();

                // 5. Actualizar controles
                startBtn.disabled = true;
                stopBtn.disabled = false;
                captureBtn.disabled = false;

                hideLoading();

            } else {
                throw new Error(data.message || 'Error desconocido');
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Error al iniciar detecci√≥n: ' + error.message);
            hideLoading();
        }
    }

    async function stopDetection() {
        if (!currentSessionId) return;

        showLoading('Deteniendo sesi√≥n...');

        try {
            // 1. Detener WebSocket
            if (websocket) {
                websocket.close();
                websocket = null;
            }

            // 2. Detener sesi√≥n en la API
            const response = await fetch(`/api/live/${currentSessionId}/stop`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            // 3. Actualizar UI
            resetUI();

            // 4. Detener intervalos
            if (updateInterval) clearInterval(updateInterval);
            if (statsInterval) clearInterval(statsInterval);

            // 5. Mostrar resumen
            hideLoading();
            alert(`Sesi√≥n finalizada. Total detecciones: ${data.session_summary.total_detections}`);

        } catch (error) {
            console.error('Error:', error);
            alert('Error al detener sesi√≥n: ' + error.message);
            hideLoading();
        }
    }

    function connectWebSocket(sessionId) {
        const wsUrl = `ws://${window.location.host}/ws/live/${sessionId}`;
        websocket = new WebSocket(wsUrl);

        websocket.onopen = function() {
            console.log('WebSocket conectado');
            document.getElementById('wsStatus').textContent = 'Conectado';

            // Mostrar canvas
            videoCanvas.style.display = 'block';
            document.getElementById('videoPlaceholder').style.display = 'none';

            // Ajustar tama√±o del canvas
            videoCanvas.width = videoCanvas.offsetWidth;
            videoCanvas.height = videoCanvas.offsetHeight;
        };

        websocket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            processFrameData(data);
        };

        websocket.onclose = function() {
            console.log('WebSocket desconectado');
            document.getElementById('wsStatus').textContent = 'Desconectado';
        };

        websocket.onerror = function(error) {
            console.error('Error WebSocket:', error);
        };
    }

    function processFrameData(data) {
        // Actualizar contador
        updateDetectionCount(data.emotions ? data.emotions.length : 0);

        // Mostrar frame
        if (data.frame) {
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
                ctx.drawImage(img, 0, 0, videoCanvas.width, videoCanvas.height);
            };
            img.src = `data:image/jpeg;base64,${data.frame}`;
        }

        // Procesar emociones detectadas
        if (data.emotions && data.emotions.length > 0) {
            const latestEmotion = data.emotions[data.emotions.length - 1];
            updateCurrentEmotion(latestEmotion);
            updateEmotionHistory(latestEmotion);
            updateEmotionCounts(latestEmotion);
        }
    }

    function updateCurrentEmotion(emotionData) {
        const emotion = emotionData.emotion;
        const confidence = Math.round(emotionData.confidence);

        // Actualizar emoci√≥n actual
        document.getElementById('currentEmotion').textContent =
            emotion.charAt(0).toUpperCase() + emotion.slice(1);

        // Actualizar barra de confianza
        document.getElementById('confidenceBar').style.width = confidence + '%';
        document.getElementById('confidenceText').textContent = `Confianza: ${confidence}%`;
    }

    function updateEmotionHistory(emotionData) {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});

        // Agregar al historial
        emotionHistory.unshift({
            emotion: emotionData.emotion,
            confidence: Math.round(emotionData.confidence),
            time: timeString
        });

        // Mantener solo las √∫ltimas 10
        if (emotionHistory.length > 10) {
            emotionHistory = emotionHistory.slice(0, 10);
        }

        // Actualizar lista en UI
        updateHistoryDisplay();
    }

    function updateEmotionCounts(emotionData) {
        const emotion = emotionData.emotion;

        if (!emotionCounts[emotion]) {
            emotionCounts[emotion] = 0;
        }
        emotionCounts[emotion]++;

        // Actualizar distribuci√≥n
        updateEmotionDistribution();
    }

    function updateEmotionDistribution() {
        const total = Object.values(emotionCounts).reduce((a, b) => a + b, 0);
        const distributionDiv = document.getElementById('emotionDistribution');

        if (total === 0) {
            distributionDiv.innerHTML = '<div class="emotion-item">Esperando datos...</div>';
            return;
        }

        // Ordenar por frecuencia
        const sortedEmotions = Object.entries(emotionCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 7); // Mostrar solo las 7 principales

        distributionDiv.innerHTML = '';

        sortedEmotions.forEach(([emotion, count]) => {
            const percentage = Math.round((count / total) * 100);
            const emotionIcon = getEmotionIcon(emotion);

            const item = document.createElement('div');
            item.className = 'emotion-item';
            item.innerHTML = `
                <span class="emotion-name">
                    ${emotionIcon} ${emotion}
                </span>
                <span class="emotion-percentage">${percentage}%</span>
            `;
            distributionDiv.appendChild(item);
        });
    }

    function updateHistoryDisplay() {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '';

        if (emotionHistory.length === 0) {
            historyList.innerHTML = '<div class="history-item">No hay detecciones recientes</div>';
            return;
        }

        emotionHistory.forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <span>${item.emotion} (${item.confidence}%)</span>
                <span class="history-time">${item.time}</span>
            `;
            historyList.appendChild(historyItem);
        });
    }

    function updateSessionInfo(data) {
        document.getElementById('sessionId').textContent = data.session_id;
        document.getElementById('statusText').textContent = 'Sesi√≥n activa';
        document.getElementById('statusDot').className = 'status-dot status-active';
        document.getElementById('sessionInfo').textContent = `Sesi√≥n: ${data.session_id.substring(0, 8)}...`;
    }

    function updateDetectionCount(count) {
        const faceCount = document.getElementById('faceCount');
        faceCount.textContent = count;

        // Actualizar contador total
        const totalDetections = Object.values(emotionCounts).reduce((a, b) => a + b, 0);
        document.getElementById('detectionCount').textContent = `${totalDetections} detecciones`;
    }

    function startStatsUpdate() {
        // Actualizar duraci√≥n cada segundo
        updateInterval = setInterval(updateDuration, 1000);

        // Actualizar estad√≠sticas de la sesi√≥n cada 5 segundos
        statsInterval = setInterval(fetchSessionStats, 5000);
    }

    function updateDuration() {
        if (!sessionStartTime) return;

        const now = new Date();
        const diff = Math.floor((now - sessionStartTime) / 1000);

        const minutes = Math.floor(diff / 60);
        const seconds = diff % 60;

        document.getElementById('duration').textContent =
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    async function fetchSessionStats() {
        if (!currentSessionId) return;

        try {
            const response = await fetch(`/api/live/${currentSessionId}/stats`);
            const data = await response.json();

            if (data.status === 'success' && data.stats.predominant_emotion) {
                document.getElementById('predominantEmotion').textContent =
                    data.stats.predominant_emotion;
            }
        } catch (error) {
            console.error('Error obteniendo estad√≠sticas:', error);
        }
    }

    async function captureFrame() {
        if (!currentSessionId) return;

        try {
            const response = await fetch(`/api/live/${currentSessionId}/frame`);
            const data = await response.json();

            // Crear enlace para descargar la imagen
            const link = document.createElement('a');
            link.href = `data:image/jpeg;base64,${data.frame}`;
            link.download = `capture_${currentSessionId}_${Date.now()}.jpg`;
            link.click();

            alert('Frame capturado y descargado');

        } catch (error) {
            console.error('Error capturando frame:', error);
            alert('Error al capturar frame');
        }
    }

    function getEmotionIcon(emotion) {
        const icons = {
            'happy': 'üòä',
            'sad': 'üò¢',
            'angry': 'üò†',
            'surprise': 'üòÆ',
            'fear': 'üò®',
            'disgust': 'ü§¢',
            'neutral': 'üòê'
        };
        return icons[emotion] || '‚ùì';
    }

    function resetUI() {
        // Limpiar canvas
        ctx.clearRect(0, 0, videoCanvas.width, videoCanvas.height);
        videoCanvas.style.display = 'none';
        document.getElementById('videoPlaceholder').style.display = 'flex';

        // Resetear variables
        emotionHistory = [];
        emotionCounts = {};
        sessionStartTime = null;

        // Resetear UI
        document.getElementById('currentEmotion').textContent = '-';
        document.getElementById('confidenceBar').style.width = '0%';
        document.getElementById('confidenceText').textContent = 'Confianza: 0%';
        document.getElementById('duration').textContent = '00:00';
        document.getElementById('faceCount').textContent = '0';
        document.getElementById('predominantEmotion').textContent = '-';
        document.getElementById('detectionCount').textContent = '0 detecciones';
        document.getElementById('statusText').textContent = 'Sesi√≥n no iniciada';
        document.getElementById('statusDot').className = 'status-dot status-inactive';
        document.getElementById('sessionInfo').textContent = 'Sin sesi√≥n activa';
        document.getElementById('sessionId').textContent = 'N/A';
        document.getElementById('wsStatus').textContent = 'Desconectado';

        // Resetear controles
        startBtn.disabled = false;
        stopBtn.disabled = true;
        captureBtn.disabled = true;

        // Limpiar listas
        updateEmotionDistribution();
        updateHistoryDisplay();
    }

    // Inicializaci√≥n
    window.addEventListener('load', function() {
        // Ajustar tama√±o del canvas cuando cambie el tama√±o de la ventana
        window.addEventListener('resize', function() {
            if (videoCanvas.style.display !== 'none') {
                videoCanvas.width = videoCanvas.offsetWidth;
                videoCanvas.height = videoCanvas.offsetHeight;
            }
        });

        // Verificar estado de la API
        fetch('/health')
            .then(response => response.json())
            .then(data => {
                console.log('API Health:', data);
            })
            .catch(error => {
                console.error('API no disponible:', error);
                alert('La API no est√° disponible. Aseg√∫rate de que el servidor est√© ejecut√°ndose.');
            });
    });

    // Cerrar WebSocket al salir de la p√°gina
    window.addEventListener('beforeunload', function() {
        if (websocket) {
            websocket.close();
        }
    });
</script>
</body>
</html>